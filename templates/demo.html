{% extends "base.html" %}

{% block title %}Interactive Demo - Multilingual Topic Clustering{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <h2 class="mb-4">
            <i class="fas fa-play-circle text-primary me-2"></i>
            Interactive Demo
        </h2>
        <p class="text-muted mb-4">
            Test the multilingual topic clustering system with your own text. Choose between single text processing or batch processing for multiple texts.
        </p>

        <!-- Processing Mode Tabs -->
        <div class="card mb-4">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="processingTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="single-tab" data-bs-toggle="tab" data-bs-target="#single-processing" type="button" role="tab">
                            <i class="fas fa-file-text me-2"></i>Single Text Processing
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="batch-tab" data-bs-toggle="tab" data-bs-target="#batch-processing" type="button" role="tab">
                            <i class="fas fa-layer-group me-2"></i>Batch Processing
                            <span class="badge bg-success ms-1">Fast</span>
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="processingTabContent">

                    <!-- Single Text Processing Tab -->
                    <div class="tab-pane fade show active" id="single-processing" role="tabpanel">
                        <form id="clusteringForm">
                            <div class="mb-3">
                                <label for="inputText" class="form-label">
                                    <i class="fas fa-file-text me-1"></i>Text Content
                                </label>
                                <textarea
                                    class="form-control"
                                    id="inputText"
                                    rows="5"
                                    placeholder="Enter your text in Hindi, English, or Hinglish...&#10;&#10;Example:&#10;लखनऊ के गोमती नगर थाने में पुलिस कदाचार की शिकायत दर्ज की गई। राम शर्मा नाम के व्यक्ति पर अत्याचार हुआ।"
                                    required>
                                </textarea>
                                <div class="form-text">
                                    Supports Hindi (Devanagari), English, and Hinglish (code-mixed) text.
                                    Minimum 3 characters, maximum 10,000 characters.
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <label for="sourceType" class="form-label">
                                        <i class="fas fa-tag me-1"></i>Source Type
                                    </label>
                                    <select class="form-select" id="sourceType">
                                        <option value="social_media">Social Media</option>
                                        <option value="whatsapp">WhatsApp</option>
                                        <option value="news">News Article</option>
                                        <option value="blog">Blog Post</option>
                                        <option value="email">Email</option>
                                        <option value="forum">Forum</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="userId" class="form-label">
                                        <i class="fas fa-user me-1"></i>User ID (Optional)
                                    </label>
                                    <input type="text" class="form-control" id="userId" placeholder="user123">
                                    <div class="form-text">For analytics and tracking purposes</div>
                                </div>
                            </div>

                            <div class="mt-4">
                                <button type="submit" class="btn btn-primary" id="processBtn">
                                    <i class="fas fa-cog me-2"></i>
                                    Process Text
                                </button>
                                <button type="button" class="btn btn-secondary ms-2" id="clearBtn">
                                    <i class="fas fa-eraser me-2"></i>
                                    Clear Form
                                </button>
                                <button type="button" class="btn btn-outline-info ms-2" onclick="loadRandomExample()">
                                    <i class="fas fa-random me-2"></i>
                                    Random Example
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Batch Processing Tab -->
                    <div class="tab-pane fade" id="batch-processing" role="tabpanel">
                        <!-- Performance Info Alert -->
                        <div class="alert alert-info mb-4">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h6 class="mb-1"><i class="fas fa-rocket me-2"></i>Performance Benefits</h6>
                                    <small>Batch processing is 60-70% faster than individual processing</small>
                                </div>
                                <div class="col-md-4 text-end">
                                    <span class="badge bg-primary">Individual: ~800ms each</span><br>
                                    <span class="badge bg-success">Batch: ~300ms each</span>
                                </div>
                            </div>
                        </div>

                        <form id="batchForm">
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="form-label">
                                        <i class="fas fa-layer-group me-1"></i>Batch Text Input
                                        <span class="badge bg-info ms-2" id="textCounter">0/10 texts</span>
                                    </label>
                                    <div>
                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addTextArea()">
                                            <i class="fas fa-plus me-1"></i>Add Text
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadSampleBatch()">
                                            <i class="fas fa-magic me-1"></i>Load Samples
                                        </button>
                                    </div>
                                </div>

                                <div id="textAreasContainer">
                                    <!-- Text areas will be dynamically added here -->
                                </div>

                                <div class="form-text">
                                    Maximum 10 texts per batch. Each text: minimum 3 characters, maximum 10,000 characters.
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <label for="batchSourceType" class="form-label">
                                        <i class="fas fa-tag me-1"></i>Source Type (All Texts)
                                    </label>
                                    <select class="form-select" id="batchSourceType">
                                        <option value="social_media">Social Media</option>
                                        <option value="whatsapp">WhatsApp</option>
                                        <option value="news">News Article</option>
                                        <option value="blog">Blog Post</option>
                                        <option value="email">Email</option>
                                        <option value="forum">Forum</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="batchUserId" class="form-label">
                                        <i class="fas fa-user me-1"></i>User ID (Optional)
                                    </label>
                                    <input type="text" class="form-control" id="batchUserId" placeholder="user123">
                                    <div class="form-text">Applied to all texts in the batch</div>
                                </div>
                            </div>

                            <div class="mt-4">
                                <button type="submit" class="btn btn-success" id="batchProcessBtn">
                                    <i class="fas fa-rocket me-2"></i>
                                    Process Batch
                                </button>
                                <button type="button" class="btn btn-secondary ms-2" onclick="clearBatchForm()">
                                    <i class="fas fa-eraser me-2"></i>
                                    Clear All
                                </button>
                                <button type="button" class="btn btn-outline-warning ms-2" onclick="compareModes()">
                                    <i class="fas fa-stopwatch me-2"></i>
                                    Compare Performance
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section (Enhanced for Batch) -->
        <div id="resultsSection" class="card" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar text-success me-2"></i>
                    <span id="resultsTitle">Processing Results</span>
                </h5>
                <div>
                    <button class="btn btn-outline-secondary btn-sm me-2" onclick="exportResults()">
                        <i class="fas fa-download me-1"></i>Export JSON
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="toggleResultsView()" id="toggleViewBtn">
                        <i class="fas fa-table me-1"></i>Table View
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="processingResults"></div>
            </div>
        </div>

        <!-- Sample Texts Section -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i>Sample Texts (Click to Try)
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3" id="sampleTexts">
                    <div class="col-md-6">
                        <div class="sample-text-card" onclick="fillSampleText(this)">
                            <div class="sample-header">
                                <span class="badge bg-danger me-2">Hindi</span>
                                <strong>Police Complaint</strong>
                            </div>
                            <p class="sample-content">
                                लखनऊ के गोमती नगर थाने में पुलिस कदाचार की शिकायत दर्ज की गई। राम शर्मा नाम के व्यक्ति पर अत्याचार हुआ। #यूपीपुलिस #न्याय
                            </p>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="sample-text-card" onclick="fillSampleText(this)">
                            <div class="sample-header">
                                <span class="badge bg-warning me-2">Hinglish</span>
                                <strong>Traffic Issue</strong>
                            </div>
                            <p class="sample-content">
                                Traffic jam ke wajah se office late pahunch gaya. Noida expressway par accident hua hai. Police ko inform karna chahiye. #NoidaTraffic #Delhi
                            </p>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="sample-text-card" onclick="fillSampleText(this)">
                            <div class="sample-header">
                                <span class="badge bg-info me-2">English</span>
                                <strong>Government Policy</strong>
                            </div>
                            <p class="sample-content">
                                The new education policy announced by the government has received mixed reactions from teachers and parents across Uttar Pradesh districts.
                            </p>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="sample-text-card" onclick="fillSampleText(this)">
                            <div class="sample-header">
                                <span class="badge bg-success me-2">Hindi</span>
                                <strong>Social Issue</strong>
                            </div>
                            <p class="sample-content">
                                आगरा में जातिगत भेदभाव के मामले में दलित परिवार ने शिकायत दर्ज कराई है। सामाजिक न्याय विभाग की जांच चल रही है।
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Statistics -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>Real-time Statistics
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-2">
                        <div class="stat-box">
                            <h4 class="text-primary" id="totalProcessed">0</h4>
                            <small class="text-muted">Texts Processed</small>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-box">
                            <h4 class="text-success" id="avgProcessingTime">0</h4>
                            <small class="text-muted">Avg Time (ms)</small>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-box">
                            <h4 class="text-info" id="languageDetected">-</h4>
                            <small class="text-muted">Last Language</small>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-box">
                            <h4 class="text-warning" id="lastAction">-</h4>
                            <small class="text-muted">Last Action</small>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-box">
                            <h4 class="text-purple" id="batchCount">0</h4>
                            <small class="text-muted">Batch Processed</small>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-box">
                            <h4 class="text-danger" id="timesSaved">0s</h4>
                            <small class="text-muted">Time Saved</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Export Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="exportContent" class="bg-light p-3" style="max-height: 400px; overflow-y: auto;"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="downloadJson()">
                    <i class="fas fa-download me-1"></i>Download JSON
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Performance Comparison Modal -->
<div class="modal fade" id="performanceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Performance Comparison</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="performanceContent">
                    <div class="text-center p-4">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">Running performance comparison...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables
let processing = false;
let lastResult = null;
let lastBatchResult = null;
let processingStats = {
    totalProcessed: 0,
    totalTime: 0,
    lastLanguage: '-',
    lastAction: '-',
    batchCount: 0,
    timeSaved: 0
};
let textAreaCount = 0;
let currentResultsView = 'cards'; // 'cards' or 'table'

// Initialize batch processing when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeBatchProcessing();
});

function initializeBatchProcessing() {
    // Add initial text areas for batch processing
    for (let i = 0; i < 3; i++) {
        addTextArea();
    }
    updateTextCounter();
}

// Single Text Processing (Enhanced)
document.getElementById('clusteringForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    if (processing) return;

    const formData = {
        text: document.getElementById('inputText').value,
        source_type: document.getElementById('sourceType').value,
        user_id: document.getElementById('userId').value || null
    };

    if (!formData.text.trim()) {
        showToast('Please enter some text to process', 'warning');
        return;
    }

    if (formData.text.length < 3) {
        showToast('Text must be at least 3 characters long', 'warning');
        return;
    }

    processing = true;
    updateProcessButton(true);

    try {
        const startTime = Date.now();
        const response = await fetch('/api/process-text', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });

        const result = await response.json();
        const endTime = Date.now();

        if (response.ok) {
            lastResult = result;
            displaySingleResult(result);
            updateStats(result, endTime - startTime, 'single');
            showToast('Text processed successfully!', 'success');
        } else {
            throw new Error(result.detail || 'Processing failed');
        }

    } catch (error) {
        showToast('Error: ' + error.message, 'danger');
        console.error('Processing error:', error);
    } finally {
        processing = false;
        updateProcessButton(false);
    }
});

// Batch Processing Form Handler
document.getElementById('batchForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    if (processing) return;

    const texts = collectBatchTexts();

    if (texts.length === 0) {
        showToast('Please add at least one text to process', 'warning');
        return;
    }

    // Validate each text
    for (let i = 0; i < texts.length; i++) {
        if (texts[i].length < 3) {
            showToast(`Text ${i + 1} must be at least 3 characters long`, 'warning');
            return;
        }
    }

    const batchData = {
        texts: texts,
        source_type: document.getElementById('batchSourceType').value,
        user_id: document.getElementById('batchUserId').value || null
    };

    processing = true;
    updateBatchProcessButton(true);

    try {
        const startTime = Date.now();
        const response = await fetch('/api/process-batch', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(batchData)
        });

        const result = await response.json();
        const endTime = Date.now();

        if (response.ok) {
            lastBatchResult = result;
            displayBatchResults(result);
            updateStats(result, endTime - startTime, 'batch');
            showToast(`Batch processed: ${result.successful}/${result.total_processed} successful!`, 'success');
        } else {
            throw new Error(result.detail || 'Batch processing failed');
        }

    } catch (error) {
        showToast('Error: ' + error.message, 'danger');
        console.error('Batch processing error:', error);
    } finally {
        processing = false;
        updateBatchProcessButton(false);
    }
});

// Batch Processing Helper Functions
function addTextArea() {
    const container = document.getElementById('textAreasContainer');
    const currentCount = container.children.length;

    if (currentCount >= 10) {
        showToast('Maximum 10 texts allowed per batch', 'warning');
        return;
    }

    textAreaCount++;
    const textAreaDiv = document.createElement('div');
    textAreaDiv.className = 'mb-3 text-area-item';
    textAreaDiv.innerHTML = `
        <div class="d-flex align-items-center mb-2">
            <label class="form-label mb-0 me-auto">
                <i class="fas fa-file-text me-1"></i>Text ${textAreaCount}
            </label>
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeTextArea(this)">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        <textarea
            class="form-control batch-textarea"
            rows="3"
            placeholder="Enter text in Hindi, English, or Hinglish..."
            data-index="${textAreaCount}">
        </textarea>
    `;

    container.appendChild(textAreaDiv);
    updateTextCounter();
}

function removeTextArea(button) {
    const container = document.getElementById('textAreasContainer');
    if (container.children.length <= 1) {
        showToast('At least one text area is required', 'warning');
        return;
    }

    button.closest('.text-area-item').remove();
    updateTextCounter();
}

function updateTextCounter() {
    const count = document.getElementById('textAreasContainer').children.length;
    document.getElementById('textCounter').textContent = `${count}/10 texts`;
}

function collectBatchTexts() {
    const textareas = document.querySelectorAll('.batch-textarea');
    const texts = [];

    textareas.forEach(textarea => {
        const text = textarea.value.trim();
        if (text) {
            texts.push(text);
        }
    });

    return texts;
}

function loadSampleBatch() {
    clearBatchForm();

    const sampleTexts = [
        "लखनऊ के गोमती नगर थाने में पुलिस कदाचार की शिकायत दर्ज की गई। राम शर्मा नाम के व्यक्ति पर अत्याचार हुआ। #यूपीपुलिस #न्याय",
        "Traffic jam ke wajah se office late pahunch gaya. Noida expressway par accident hua hai. Police ko inform karna chahiye. #NoidaTraffic #Delhi",
        "The new education policy announced by the government has received mixed reactions from teachers and parents across Uttar Pradesh districts.",
        "आगरा में जातिगत भेदभाव के मामले में दलित परिवार ने शिकायत दर्ज कराई है। सामाजिक न्याय विभाग की जांच चल रही है।",
        "मुरादाबाद में चोरी की घटना हुई है। थाना कोतवाली में FIR दर्ज की गई है। #मुरादाबादपुलिस"
    ];

    // Clear existing text areas
    document.getElementById('textAreasContainer').innerHTML = '';
    textAreaCount = 0;

    // Add sample texts
    sampleTexts.forEach(text => {
        addTextArea();
        const textareas = document.querySelectorAll('.batch-textarea');
        const lastTextarea = textareas[textareas.length - 1];
        lastTextarea.value = text;
    });

    showToast('Sample batch loaded successfully!', 'success');
}

function clearBatchForm() {
    const textareas = document.querySelectorAll('.batch-textarea');
    textareas.forEach(textarea => {
        textarea.value = '';
    });

    document.getElementById('batchUserId').value = '';
}

// Results Display Functions
function displaySingleResult(result) {
    document.getElementById('resultsTitle').textContent = 'Single Text Processing Results';
    const resultsDiv = document.getElementById('processingResults');

    const confidenceBadge = getConfidenceBadge(result.confidence);
    const actionBadge = getActionBadge(result.action);

    const html = `
        <div class="row g-4">
            <div class="col-md-6">
                <div class="result-card">
                    <h6><i class="fas fa-info-circle text-primary me-2"></i>Basic Information</h6>
                    <table class="table table-sm table-borderless">
                        <tr>
                            <td><strong>Action:</strong></td>
                            <td>${actionBadge}</td>
                        </tr>
                        <tr>
                            <td><strong>Language:</strong></td>
                            <td>
                                ${result.detected_language}
                                <span class="text-muted">(${(result.language_confidence * 100).toFixed(1)}%)</span>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Confidence:</strong></td>
                            <td>${confidenceBadge}</td>
                        </tr>
                        <tr>
                            <td><strong>Similarity:</strong></td>
                            <td>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar" style="width: ${result.similarity_score * 100}%">
                                        ${(result.similarity_score * 100).toFixed(1)}%
                                    </div>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Processing Time:</strong></td>
                            <td><span class="badge bg-info">${result.processing_time_ms}ms</span></td>
                        </tr>
                    </table>
                </div>
            </div>

            <div class="col-md-6">
                <div class="result-card">
                    <h6><i class="fas fa-tag text-success me-2"></i>Topic Information</h6>
                    <div class="mb-2">
                        <strong>Title:</strong>
                        <span class="topic-title">${result.topic_title || 'N/A'}</span>
                    </div>
                    <div class="mb-2">
                        <strong>ID:</strong>
                        <code class="text-muted">${result.topic_id || 'N/A'}</code>
                    </div>
                    <div class="mb-2">
                        <strong>Entities Found:</strong>
                        <div class="mt-1">
                            ${generateEntityBadges(result.extracted_entities)}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    resultsDiv.innerHTML = html;
    document.getElementById('resultsSection').style.display = 'block';
    currentResultsView = 'cards';
}

function displayBatchResults(result) {
    document.getElementById('resultsTitle').textContent =
        `Batch Processing Results (${result.successful}/${result.total_processed} successful)`;

    const resultsDiv = document.getElementById('processingResults');

    // Performance summary
    const avgTimePerText = result.processing_time_ms / result.total_processed;
    const estimatedIndividualTime = result.total_processed * 800; // Estimated individual processing time
    const timeSaved = estimatedIndividualTime - result.processing_time_ms;

    const summaryHtml = `
        <div class="alert alert-success mb-4">
            <div class="row">
                <div class="col-md-3 text-center">
                    <h4 class="mb-1">${result.total_processed}</h4>
                    <small>Texts Processed</small>
                </div>
                <div class="col-md-3 text-center">
                    <h4 class="mb-1">${result.processing_time_ms}ms</h4>
                    <small>Total Time</small>
                </div>
                <div class="col-md-3 text-center">
                    <h4 class="mb-1">${avgTimePerText.toFixed(0)}ms</h4>
                    <small>Avg per Text</small>
                </div>
                <div class="col-md-3 text-center">
                    <h4 class="mb-1 text-success">${(timeSaved/1000).toFixed(1)}s</h4>
                    <small>Time Saved</small>
                </div>
            </div>
        </div>
    `;

    // Results cards or table view
    let resultsHtml = '';

    if (currentResultsView === 'cards') {
        resultsHtml = `
            <div class="row g-3">
                ${result.results.map((item, index) => `
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">Text ${index + 1}</h6>
                                <span class="badge ${getActionBadgeClass(item.action)}">${item.action}</span>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <strong>Topic:</strong> ${item.topic_title || 'N/A'}
                                </div>
                                <div class="mb-2">
                                    <strong>Language:</strong>
                                    <span class="badge ${getLanguageBadgeClass(item.detected_language)}">${item.detected_language}</span>
                                    <span class="text-muted">(${(item.language_confidence * 100).toFixed(1)}%)</span>
                                </div>
                                <div class="mb-2">
                                    <strong>Similarity:</strong>
                                    <div class="progress" style="height: 15px;">
                                        <div class="progress-bar" style="width: ${item.similarity_score * 100}%">
                                            ${(item.similarity_score * 100).toFixed(1)}%
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <strong>Entities:</strong>
                                    <div class="mt-1">
                                        ${generateEntityBadges(item.extracted_entities)}
                                    </div>
                                </div>
                                <div class="text-muted small">
                                    <strong>Text:</strong> ${item.input_text.substring(0, 100)}${item.input_text.length > 100 ? '...' : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    } else {
        resultsHtml = `
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>#</th>
                            <th>Text Preview</th>
                            <th>Topic</th>
                            <th>Language</th>
                            <th>Action</th>
                            <th>Similarity</th>
                            <th>Entities</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${result.results.map((item, index) => `
                            <tr>
                                <td>${index + 1}</td>
                                <td style="max-width: 200px;">
                                    <div class="text-truncate" title="${item.input_text}">
                                        ${item.input_text.substring(0, 50)}${item.input_text.length > 50 ? '...' : ''}
                                    </div>
                                </td>
                                <td style="max-width: 150px;">
                                    <div class="text-truncate" title="${item.topic_title}">
                                        ${item.topic_title || 'N/A'}
                                    </div>
                                </td>
                                <td>
                                    <span class="badge ${getLanguageBadgeClass(item.detected_language)}">${item.detected_language}</span>
                                </td>
                                <td>
                                    <span class="badge ${getActionBadgeClass(item.action)}">${item.action}</span>
                                </td>
                                <td>
                                    <div class="progress" style="width: 80px; height: 15px;">
                                        <div class="progress-bar progress-bar-striped" style="width: ${item.similarity_score * 100}%"></div>
                                    </div>
                                    <small>${(item.similarity_score * 100).toFixed(1)}%</small>
                                </td>
                                <td>
                                    ${getEntityCount(item.extracted_entities)} entities
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    // Error section if any
    let errorHtml = '';
    if (result.errors && result.errors.length > 0) {
        errorHtml = `
            <div class="alert alert-warning mt-3">
                <h6><i class="fas fa-exclamation-triangle me-2"></i>Processing Errors</h6>
                <ul class="mb-0">
                    ${result.errors.map(error => `<li>${error}</li>`).join('')}
                </ul>
            </div>
        `;
    }

    resultsDiv.innerHTML = summaryHtml + resultsHtml + errorHtml;
    document.getElementById('resultsSection').style.display = 'block';
}

// Helper Functions for Display
function generateEntityBadges(entities) {
    if (!entities) return '<span class="text-muted">No entities</span>';

    const badges = [];

    if (entities.person_names && entities.person_names.length > 0) {
        badges.push(`<span class="badge bg-primary me-1">${entities.person_names.length} Person(s)</span>`);
    }
    if (entities.location_names && entities.location_names.length > 0) {
        badges.push(`<span class="badge bg-success me-1">${entities.location_names.length} Location(s)</span>`);
    }
    if (entities.incidents && entities.incidents.length > 0) {
        badges.push(`<span class="badge bg-danger me-1">${entities.incidents.length} Incident(s)</span>`);
    }
    if (entities.organisation_names && entities.organisation_names.length > 0) {
        badges.push(`<span class="badge bg-info me-1">${entities.organisation_names.length} Org(s)</span>`);
    }

    return badges.length > 0 ? badges.join('') : '<span class="text-muted">No entities</span>';
}

function getEntityCount(entities) {
    if (!entities) return 0;

    let count = 0;
    const fields = ['person_names', 'location_names', 'incidents', 'organisation_names', 'district_names', 'thana_names'];

    fields.forEach(field => {
        if (entities[field] && Array.isArray(entities[field])) {
            count += entities[field].length;
        }
    });

    return count;
}

function getActionBadgeClass(action) {
    const actionClasses = {
        'new_topic_created': 'bg-success',
        'grouped': 'bg-info',
        'error': 'bg-danger'
    };
    return actionClasses[action] || 'bg-secondary';
}

function getLanguageBadgeClass(language) {
    const languageClasses = {
        'hindi': 'bg-danger',
        'english': 'bg-primary',
        'hinglish': 'bg-warning text-dark'
    };
    return languageClasses[language] || 'bg-secondary';
}

// Toggle between card and table view
function toggleResultsView() {
    if (currentResultsView === 'cards') {
        currentResultsView = 'table';
        document.getElementById('toggleViewBtn').innerHTML = '<i class="fas fa-th me-1"></i>Card View';
    } else {
        currentResultsView = 'cards';
        document.getElementById('toggleViewBtn').innerHTML = '<i class="fas fa-table me-1"></i>Table View';
    }

    // Re-display results with new view
    if (lastBatchResult) {
        displayBatchResults(lastBatchResult);
    }
}

// Button Update Functions
function updateProcessButton(isProcessing) {
    const processBtn = document.getElementById('processBtn');
    if (isProcessing) {
        processBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
        processBtn.disabled = true;
    } else {
        processBtn.innerHTML = '<i class="fas fa-cog me-2"></i>Process Text';
        processBtn.disabled = false;
    }
}

function updateBatchProcessButton(isProcessing) {
    const batchBtn = document.getElementById('batchProcessBtn');
    if (isProcessing) {
        batchBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing Batch...';
        batchBtn.disabled = true;
    } else {
        batchBtn.innerHTML = '<i class="fas fa-rocket me-2"></i>Process Batch';
        batchBtn.disabled = false;
    }
}

// Statistics Updates
function updateStats(result, processingTime, type) {
    if (type === 'single') {
        processingStats.totalProcessed += 1;
        processingStats.totalTime += processingTime;
        processingStats.lastLanguage = result.detected_language;
        processingStats.lastAction = result.action;
    } else if (type === 'batch') {
        processingStats.totalProcessed += result.total_processed;
        processingStats.totalTime += processingTime;
        processingStats.batchCount += 1;

        // Calculate time saved
        const estimatedIndividualTime = result.total_processed * 800;
        const timeSaved = estimatedIndividualTime - processingTime;
        processingStats.timeSaved += timeSaved / 1000; // Convert to seconds

        // Use last successful result for display
        const lastSuccess = result.results.find(r => r.detected_language);
        if (lastSuccess) {
            processingStats.lastLanguage = lastSuccess.detected_language;
            processingStats.lastAction = lastSuccess.action;
        }
    }

    document.getElementById('totalProcessed').textContent = processingStats.totalProcessed;
    document.getElementById('avgProcessingTime').textContent =
        (processingStats.totalTime / Math.max(processingStats.totalProcessed, 1)).toFixed(0);
    document.getElementById('languageDetected').textContent = processingStats.lastLanguage;
    document.getElementById('lastAction').textContent = processingStats.lastAction;
    document.getElementById('batchCount').textContent = processingStats.batchCount;
    document.getElementById('timesSaved').textContent = processingStats.timeSaved.toFixed(1) + 's';
}

// Performance comparison function
async function compareModes() {
    const modal = new bootstrap.Modal(document.getElementById('performanceModal'));
    modal.show();

    const sampleTexts = [
        "लखनऊ में पुलिस कदाचार की शिकायत",
        "Traffic jam in Delhi today",
        "आगरा में सामाजिक घटना"
    ];

    try {
        // Test individual processing
        const individualStart = Date.now();
        const individualPromises = sampleTexts.map(async (text) => {
            const response = await fetch('/api/process-text', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text, source_type: 'demo' })
            });
            return response.json();
        });

        await Promise.all(individualPromises);
        const individualTime = Date.now() - individualStart;

        // Test batch processing
        const batchStart = Date.now();
        const batchResponse = await fetch('/api/process-batch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                texts: sampleTexts,
                source_type: 'demo'
            })
        });

        await batchResponse.json();
        const batchTime = Date.now() - batchStart;

        // Display results
        const improvement = ((individualTime - batchTime) / individualTime * 100).toFixed(1);
        const speedup = (individualTime / batchTime).toFixed(1);

        document.getElementById('performanceContent').innerHTML = `
            <div class="row text-center">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="text-primary">Individual Processing</h5>
                            <h3>${individualTime}ms</h3>
                            <p class="text-muted">Processing ${sampleTexts.length} texts separately</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="text-success">Batch Processing</h5>
                            <h3>${batchTime}ms</h3>
                            <p class="text-muted">Processing ${sampleTexts.length} texts together</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <h5>Performance Gain</h5>
                            <h3>${improvement}% faster</h3>
                            <p>${speedup}x speedup</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-4 alert alert-info">
                <h6><i class="fas fa-info-circle me-2"></i>Analysis</h6>
                <p class="mb-0">
                    Batch processing is <strong>${improvement}% faster</strong> than individual processing.
                    This improvement comes from shared NER processing, batch embedding generation,
                    and reduced API overhead.
                </p>
            </div>
        `;

    } catch (error) {
        document.getElementById('performanceContent').innerHTML = `
            <div class="alert alert-danger">
                <h6>Performance Test Failed</h6>
                <p class="mb-0">Error: ${error.message}</p>
            </div>
        `;
    }
}

// Original helper functions (keep these unchanged)
function getConfidenceBadge(confidence) {
    const confValue = typeof confidence === 'string' ?
        (confidence === 'high' ? 0.9 : confidence === 'medium' ? 0.7 : 0.5) :
        confidence;

    if (confValue >= 0.8) {
        return `<span class="badge bg-success">${typeof confidence === 'string' ? confidence : (confValue * 100).toFixed(1) + '%'}</span>`;
    } else if (confValue >= 0.5) {
        return `<span class="badge bg-warning">${typeof confidence === 'string' ? confidence : (confValue * 100).toFixed(1) + '%'}</span>`;
    } else {
        return `<span class="badge bg-danger">${typeof confidence === 'string' ? confidence : (confValue * 100).toFixed(1) + '%'}</span>`;
    }
}

function getActionBadge(action) {
    if (action === 'new_topic_created') {
        return `<span class="badge bg-success">New Topic</span>`;
    } else if (action === 'grouped') {
        return `<span class="badge bg-info">Grouped</span>`;
    } else {
        return `<span class="badge bg-warning">Other</span>`;
    }
}

function showToast(message, type) {
    // Create toast if it doesn't exist
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }

    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.setAttribute('role', 'alert');

    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;

    toastContainer.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();

    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function exportResults() {
    const modalContent = document.getElementById('exportContent');
    const dataToExport = lastBatchResult || lastResult;
    modalContent.textContent = JSON.stringify(dataToExport, null, 2);
    new bootstrap.Modal(document.getElementById('exportModal')).show();
}

function downloadJson() {
    const dataToExport = lastBatchResult || lastResult;
    const jsonData = JSON.stringify(dataToExport, null, 2);
    const blob = new Blob([jsonData], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = lastBatchResult ? 'batch_processing_results.json' : 'processing_results.json';
    a.click();
    URL.revokeObjectURL(url);
}

function fillSampleText(element) {
    const sampleText = element.querySelector('.sample-content').textContent;
    const activeTab = document.querySelector('#processingTabs .nav-link.active').id;

    if (activeTab === 'single-tab') {
        document.getElementById('inputText').value = sampleText;
    } else {
        // Add to batch processing
        const textareas = document.querySelectorAll('.batch-textarea');
        const emptyTextarea = Array.from(textareas).find(ta => !ta.value.trim());

        if (emptyTextarea) {
            emptyTextarea.value = sampleText;
        } else {
            addTextArea();
            const newTextareas = document.querySelectorAll('.batch-textarea');
            newTextareas[newTextareas.length - 1].value = sampleText;
        }
    }
}

function loadRandomExample() {
    const randomIndex = Math.floor(Math.random() * sampleTexts.length);
    const randomSample = sampleTexts[randomIndex];
    document.getElementById('inputText').value = randomSample.text;
}

// Clear button functionality
document.getElementById('clearBtn').addEventListener('click', function() {
    document.getElementById('inputText').value = '';
    document.getElementById('userId').value = '';
});

const sampleTexts = [
    {
        text: "लखनऊ के गोमती नगर थाने में पुलिस कदाचार की शिकायत दर्ज की गई। राम शर्मा नाम के व्यक्ति पर अत्याचार हुआ। #यूपीपुलिस #न्याय",
        language: "Hindi"
    },
    {
        text: "Traffic jam ke wajah se office late pahunch gaya. Noida expressway par accident hua hai. Police ko inform karna chahiye. #NoidaTraffic #Delhi",
        language: "Hinglish"
    },
    {
        text: "The new education policy announced by the government has received mixed reactions from teachers and parents across Uttar Pradesh districts.",
        language: "English"
    },
    {
        text: "आगरा में जातिगत भेदभाव के मामले में दलित परिवार ने शिकायत दर्ज कराई है। सामाजिक न्याय विभाग की जांच चल रही है।",
        language: "Hindi"
    }
];
</script>
{% endblock %}